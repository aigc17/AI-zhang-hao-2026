/**
 * [INPUT]: 无外部依赖
 * [OUTPUT]: BrandIcon 组件 + ICON_LIST 图标库（供 CategoryForm 图标选择器使用）
 * [POS]: 图标映射层，PNG 图标来自 public/icons/，SVG path 来自 simpleicons.org，统一 22% 圆角
 *
 * [PROTOCOL]: 变更时更新此头部，然后检查 CLAUDE.md
 */

import React from 'react';
import { Key, BookOpen } from 'lucide-react';

// ─── SVG Path Data (source: simpleicons.org) ─────────────────────────────────
// 注：openai/anthropic/gemini/perplexity/x 已升级为 aihubmix SVG 文件，不再需要 path

const PATH_MIDJOURNEY =
  'M22.369 17.676c-1.387 1.259-3.17 2.378-5.332 3.417.044.03.086.057.13.083l.018.01.019.012c.216.123.42.184.641.184.222 0 .426-.061.642-.184l.018-.011.019-.011c' +
  '.14-.084.266-.178.492-.366l.178-.148c.279-.232.426-.342.625-.456.304-.174.612-.266.949-.266.337 0 .645.092.949.266l.023.014c.188.109.334.219.602.442l.178.148c' +
  '.221.184.346.278.483.36l.028.017.018.01c.21.12.407.181.62.185h.022a.31.31 0 110 .618c-.337 0-.645-.092-.95-.266a3.137 3.137 0 01-.09-.054l-.022-.014-.022-.013' +
  '-.02-.014a5.356 5.356 0 01-.49-.377l-.159-.132a3.836 3.836 0 00-.483-.36l-.027-.017-.019-.01a1.256 1.256 0 00-.641-.185c-.222 0-.426.061-.641.184l-.02.011-.018' +
  '.011c-.14.084-.266.178-.492.366l-.158.132a5.125 5.125 0 01-.51.39l-.022.014-.022.014-.09.054a1.868 1.868 0 01-.95.266c-.337 0-.644-.092-.949-.266a3.137 3.137 0 ' +
  '01-.09-.054l-.022-.014-.022-.013-.026-.017a4.881 4.881 0 01-.425-.325.308.308 0 01-.12-.1l-.098-.081a3.836 3.836 0 00-.483-.36l-.027-.017-.019-.01a1.256 1.256 0 ' +
  '00-.641-.185c-.222 0-.426.061-.642.184l-.018.011-.019.011c-.14.084-.266.178-.492.366l-.158.132a5.125 5.125 0 01-.51.39l-.023.014-.022.014-.09.054A1.868 1.868 0 ' +
  '0112 22c-.337 0-.645-.092-.949-.266a3.137 3.137 0 01-.09-.054l-.022-.014-.022-.013-.021-.014a5.356 5.356 0 01-.49-.377l-.158-.132a3.836 3.836 0 00-.483-.36l' +
  '-.028-.017-.018-.01a1.256 1.256 0 00-.642-.185c-.221 0-.425.061-.641.184l-.019.011-.018.011c-.141.084-.266.178-.492.366l-.158.132a5.125 5.125 0 01-.511.39l' +
  '-.022.014-.022.014-.09.054a1.868 1.868 0 01-.986.264c-.746-.09-1.319-.38-1.89-.866l-.035-.03c-.047-.041-.118-.106-.192-.174l-.196-.181-.107-.1-.011-.01a1.531 ' +
  '1.531 0 00-.336-.253.313.313 0 00-.095-.03h-.005c-.119.022-.238.059-.361.11a.308.308 0 01-.077.061l-.008.005a.309.309 0 01-.126.034 5.66 5.66 0 00-.774.518l' +
  '-.416.324-.055.043a6.542 6.542 0 01-.324.236c-.305.207-.552.315-.8.315a.31.31 0 01-.01-.618h.01c.09 0 .235-.062.438-.198l.04-.027c.077-.054.163-.117.27-.199l' +
  '.385-.301.06-.047c.268-.206.506-.373.73-.505l-.633-1.21a.309.309 0 01.254-.451l20.287-1.305a.309.309 0 01.228.537zm-1.118.14L2.369 19.03l.423.809c.128-.045' +
  '.256-.078.388-.1a.31.31 0 01.052-.005c.132 0 .26.032.386.093.153.073.294.179.483.35l.016.015.092.086.144.134.097.089c.065.06.125.114.16.144.485.418.948.658 ' +
  '1.554.736h.011a1.25 1.25 0 00.6-.172l.021-.011.019-.011.018-.011c.141-.084.266-.178.492-.366l.178-.148c.279-.232.426-.342.625-.456.305-.174.612-.266.95-.266' +
  '.336 0 .644.092.948.266l.023.014c.188.109.335.219.603.442l.177.148c.222.184.346.278.484.36l.027.017.019.01c.215.124.42.185.641.185.222 0 .426-.061.641-.184l' +
  '.019-.011.018-.011c.141-.084.267-.178.493-.366l.177-.148c.28-.232.427-.342.626-.456.304-.174.612-.266.949-.266.337 0 .644.092.949.266l.025.015c.187.109.334.22' +
  '.603.443 1.867-.878 3.448-1.811 4.73-2.832l.02-.016zM3.653 2.026C6.073 3.06 8.69 4.941 10.8 7.258c2.46 2.7 4.109 5.828 4.637 9.149a.31.31 0 01-.421.335c-2.348' +
  '-.945-4.54-1.258-6.59-1.02-1.739.2-3.337.792-4.816 1.703-.294.182-.62-.182-.405-.454 1.856-2.355 2.581-4.99 2.343-7.794-.195-2.292-1.031-4.61-2.284-6.709a.31' +
  '.31 0 01.388-.442zM10.04 4.45c1.778.543 3.892 2.102 5.782 4.243 1.984 2.248 3.552 4.934 4.347 7.582a.31.31 0 01-.401.38l-.022-.01-.386-.154a10.594 10.594 0 00' +
  '-.291-.112l-.016-.006c-.68-.247-1.199-.291-1.944-.101a.31.31 0 01-.375-.218C15.378 11.123 13.073 7.276 9.775 5c-.291-.201-.072-.653.266-.55zM4.273 2.996l.008' +
  '.015c1.028 1.94 1.708 4.031 1.885 6.113.213 2.513-.31 4.906-1.673 7.092l-.02.031.003-.001c1.198-.581 2.47-.969 3.825-1.132l.055-.006c1.981-.23 4.083.029 6.309' +
  '.837l.066.025-.007-.039c-.593-2.95-2.108-5.737-4.31-8.179l-.07-.078c-1.785-1.96-3.944-3.6-6.014-4.65l-.057-.028zm7.92 3.238l.048.048c2.237 2.295 3.885 5.431 ' +
  '4.974 9.191l.038.132.022-.004c.71-.133 1.284-.063 1.963.18l.027.01.066.024.046.018-.025-.073c-.811-2.307-2.208-4.62-3.936-6.594l-.058-.065c-1.02-1.155-2.103' +
  '-2.132-3.15-2.856l-.015-.011z';

const PATH_PHOTOSHOP =
  'M9.85 8.42c-.37-.15-.77-.21-1.18-.2-.26 0-.49 0-.68.01-.2-.01-.34 0-.41.01v3.36c.14.01.27.02.39.02h.53c.39 0 .78-.06 1.15-.18.32-.09.6-.28.82-.53' +
  '.21-.25.31-.59.31-1.03.01-.31-.07-.62-.23-.89-.17-.26-.41-.46-.7-.57zM19.75.3H4.25C1.9.3 0 2.2 0 4.55v14.899c0 2.35 1.9 4.25 4.25 4.25h15.5c2.35 0 ' +
  '4.25-1.9 4.25-4.25V4.55C24 2.2 22.1.3 19.75.3zm-7.391 11.65c-.399.56-.959.98-1.609 1.22-.68.25-1.43.34-2.25.34-.24 0-.4 0-.5-.01s-.24-.01-.43-.01v3.209' +
  'c.01.07-.04.131-.11.141H5.52c-.08 0-.12-.041-.12-.131V6.42c0-.07.03-.11.1-.11.17 0 .33 0 .56-.01.24-.01.49-.01.76-.02s.56-.01.87-.02c.31-.01.61-.01.91-.01' +
  '.82 0 1.5.1 2.06.31.5.17.96.45 1.34.82.32.32.57.71.73 1.14.149.42.229.85.229 1.3.001.86-.199 1.57-.6 2.13zm7.091 3.89c-.28.4-.671.709-1.12.891-.49.209' +
  '-1.09.318-1.811.318-.459 0-.91-.039-1.359-.129-.35-.061-.7-.17-1.02-.32-.07-.039-.121-.109-.111-.189v-1.74c0-.029.011-.07.041-.09.029-.02.06-.01.09.01' +
  '.39.23.8.391 1.24.49.379.1.779.15 1.18.15.38 0 .65-.051.83-.141.16-.07.27-.24.27-.42 0-.141-.08-.27-.24-.4-.16-.129-.489-.279-.979-.471-.51-.18-.979-.42' +
  '-1.42-.719-.31-.221-.569-.51-.761-.85-.159-.32-.239-.67-.229-1.021 0-.43.12-.84.341-1.21.25-.4.619-.72 1.049-.92.469-.239 1.059-.349 1.769-.349.41 0 ' +
  '.83.03 1.24.09.3.04.59.12.86.23.039.01.08.05.1.09.01.04.02.08.02.12v1.63c0 .04-.02.08-.05.1-.09.02-.14.02-.18 0-.3-.16-.62-.27-.96-.34-.37-.08-.74-.13' +
  '-1.12-.13-.2-.01-.41.02-.601.07-.129.03-.24.1-.31.2-.05.08-.08.18-.08.27s.04.18.101.26c.09.11.209.2.34.27.229.12.47.23.709.33.541.18 1.061.43 1.541.73' +
  '.33.209.6.49.789.83.16.318.24.67.23 1.029.011.471-.129.94-.389 1.331';


const PATH_META =
  'M6.915 4.03c-1.968 0-3.683 1.28-4.871 3.113C.704 9.208 0 11.883 0 14.449c0 .706.07 1.369.21 1.973a6.624 6.624 0 0 0 .265.86 5.297 5.297 0 0 0 .371.761c.696 ' +
  '1.159 1.818 1.927 3.593 1.927 1.497 0 2.633-.671 3.965-2.444.76-1.012 1.144-1.626 2.663-4.32l.756-1.339.186-.325c.061.1.121.196.183.3l2.152 3.595c.724 1.21 ' +
  '1.665 2.556 2.47 3.314 1.046.987 1.992 1.22 3.06 1.22 1.075 0 1.876-.355 2.455-.843a3.743 3.743 0 0 0 .81-.973c.542-.939.861-2.127.861-3.745 0-2.72-.681-5.357 ' +
  '-2.084-7.45-1.282-1.912-2.957-2.93-4.716-2.93-1.047 0-2.088.467-3.053 1.308-.652.57-1.257 1.29-1.82 2.05-.69-.875-1.335-1.547-1.958-2.056-1.182-.966-2.315-1.303 ' +
  '-3.454-1.303zm10.16 2.053c1.147 0 2.188.758 2.992 1.999 1.132 1.748 1.647 4.195 1.647 6.4 0 1.548-.368 2.9-1.839 2.9-.58 0-1.027-.23-1.664-1.004-.496-.601 ' +
  '-1.343-1.878-2.832-4.358l-.617-1.028a44.908 44.908 0 0 0-1.255-1.98c.07-.109.141-.224.211-.327 1.12-1.667 2.118-2.602 3.358-2.602zm-10.201.553c1.265 0 2.058.791 ' +
  '2.675 1.446.307.327.737.871 1.234 1.579l-1.02 1.566c-.757 1.163-1.882 3.017-2.837 4.338-1.191 1.649-1.81 1.817-2.486 1.817-.524 0-1.038-.237-1.383-.794-.263-.426 ' +
  '-.464-1.13-.464-2.046 0-2.221.63-4.535 1.66-6.088.454-.687.964-1.226 1.533-1.533a2.264 2.264 0 0 1 1.088-.285z';

const PATH_CURSOR = 'M11.503.131 1.891 5.678a.84.84 0 0 0-.42.726v11.188c0 .3.162.575.42.724l9.609 5.55a1 1 0 0 0 .998 0l9.61-5.55a.84.84 0 0 0 .42-.724V6.404a.84.84 0 0 0-.42-.726L12.497.131a1.01 1.01 0 0 0-.996 0M2.657 6.338h18.55c.263 0 .43.287.297.515L12.23 22.918c-.062.107-.229.064-.229-.06V12.335a.59.59 0 0 0-.295-.51l-9.11-5.257c-.109-.063-.064-.23.061-.23';

const PATH_GITHUB = 'M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12';

const PATH_NOTION = 'M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 1.968c-.42-.326-.981-.7-2.055-.607L3.01 2.295c-.466.046-.56.28-.374.466zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046.935-.56.935-1.167V6.354c0-.606-.233-.933-.748-.887l-15.177.887c-.56.047-.747.327-.747.933zm14.337.745c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952L12.21 19s0 .84-1.168.84l-3.222.186c-.093-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.139c-.093-.514.28-.887.747-.933zM1.936 1.035l13.31-.98c1.634-.14 2.055-.047 3.082.7l4.249 2.986c.7.513.934.653.934 1.213v16.378c0 1.026-.373 1.634-1.68 1.726l-15.458.934c-.98.047-1.448-.093-1.962-.747l-3.129-4.06c-.56-.747-.793-1.306-.793-1.96V2.667c0-.839.374-1.54 1.447-1.632z';


// ─── Brand Colors (bg, fg) for SVG/Letter badge tools ─────────────────────────
const BRAND_COLORS: Record<string, [string, string]> = {
  midjourney: ['#f3f4f6', '#374151'],
  cursor:     ['#000000', '#ffffff'],
  meta:       ['#0082FB', '#ffffff'],
  github:     ['#24292F', '#ffffff'],
  notion:     ['#000000', '#ffffff'],
  photoshop:  ['#f3f4f6', '#374151'],
  stability:  ['#7C3AED', '#ffffff'],
  runway:     ['#000000', '#ffffff'],
};

// ─── Icon Registry ────────────────────────────────────────────────────────────
export interface IconDef {
  slug: string;
  label: string;
  path?: string;  // SVG path (simpleicons.org)
  img?: string;   // URL in public/icons/
}

export const ICON_LIST: IconDef[] = [
  { slug: 'openai',       label: 'ChatGPT',     img: '/icons/openai.svg' },
  { slug: 'anthropic',    label: 'Claude',      img: '/icons/anthropic.svg' },
  { slug: 'gemini',       label: 'Gemini',      img: '/icons/gemini.svg' },
  { slug: 'midjourney',   label: 'Midjourney',  path: PATH_MIDJOURNEY },
  { slug: 'deepseek',     label: 'DeepSeek',    img: '/icons/deepseek.png' },
  { slug: 'perplexity',   label: 'Perplexity',  img: '/icons/perplexity.svg' },
  { slug: 'cursor',       label: 'Cursor',      path: PATH_CURSOR },
  { slug: 'meta',         label: 'Meta AI',     path: PATH_META },
  { slug: 'github',       label: 'Copilot',     path: PATH_GITHUB },
  { slug: 'notion',       label: 'Notion',      path: PATH_NOTION },
  { slug: 'x',            label: 'Grok',        img: '/icons/x.svg' },
  { slug: 'stability',    label: 'Stable Diff' },
  { slug: 'suno',         label: 'Suno',        img: '/icons/suno.png' },
  { slug: 'runway',       label: 'Runway' },
  { slug: 'elevenlabs',   label: 'ElevenLabs',  img: '/icons/elevenlabs.png' },
  { slug: 'doubao',       label: '豆包',        img: '/icons/doubao.png' },
  { slug: 'volcengine',   label: '火山引擎',    img: '/icons/volcengine.png' },
  { slug: 'kling',        label: '可灵',        img: '/icons/kling.png' },
  { slug: 'wenxin',       label: '文心一言',    img: '/icons/wenxin.png' },
  { slug: 'qwen',         label: '通义千问',    img: '/icons/qwen.png' },
  { slug: 'jimeng',       label: '即梦',        img: '/icons/jimeng.png' },
  { slug: 'iflytek',      label: '讯飞星火',    img: '/icons/iflytek.png' },
  { slug: 'huggingface',  label: 'HuggingFace', img: '/icons/huggingface.png' },
  { slug: 'photoshop',    label: 'Photoshop',   path: PATH_PHOTOSHOP },
  { slug: 'flowith',     label: 'Flowith',     img: '/icons/flowith.png' },
];

// ─── Name → Slug mapping (backward compat for existing categories) ────────────
const NAME_RULES: [string, string][] = [
  ['gpt', 'openai'], ['openai', 'openai'], ['chatgpt', 'openai'],
  ['claude', 'anthropic'], ['anthropic', 'anthropic'],
  ['gemini', 'gemini'],
  ['midjourney', 'midjourney'],
  ['deepseek', 'deepseek'],
  ['kimi', 'deepseek'], ['moonshot', 'deepseek'],
  ['doubao', 'doubao'], ['豆包', 'doubao'], ['字节', 'doubao'],
  ['wenxin', 'wenxin'], ['文心', 'wenxin'], ['baidu', 'wenxin'], ['百度', 'wenxin'],
  ['qwen', 'qwen'], ['通义', 'qwen'], ['alibaba', 'qwen'], ['阿里', 'qwen'],
  ['kuaishou', 'kling'], ['快手', 'kling'], ['kling', 'kling'], ['可灵', 'kling'],
  ['volcengine', 'volcengine'], ['火山', 'volcengine'],
  ['psai', 'photoshop'], ['ps ai', 'photoshop'],
  ['cursor', 'cursor'],
  ['perplexity', 'perplexity'],
  ['hugging', 'huggingface'],
  ['meta', 'meta'], ['llama', 'meta'],
  ['suno', 'suno'], ['runway', 'runway'],
  ['stable', 'stability'], ['stability', 'stability'],
  ['elevenlabs', 'elevenlabs'], ['eleven labs', 'elevenlabs'],
  ['notion', 'notion'],
  ['github', 'github'], ['copilot', 'github'],
  ['grok', 'x'], [' xai', 'x'],
  ['即梦', 'jimeng'], ['jimeng', 'jimeng'], ['启梦', 'jimeng'], ['qimeng', 'jimeng'],
  ['讯飞', 'iflytek'], ['iflytek', 'iflytek'], ['星火', 'iflytek'],
  ['flowith', 'flowith'], ['知识库', 'flowith'],
];

function nameToSlug(name: string): string {
  const lower = name.toLowerCase();
  for (const [key, slug] of NAME_RULES) {
    if (lower.includes(key.toLowerCase())) return slug;
  }
  return '';
}

// ─── Render helpers ───────────────────────────────────────────────────────────
const ICON_BORDER = '1px solid rgba(0,0,0,0.08)';

/** PNG icon：22% 圆角填满 size，iOS App Icon 风格 */
function ImgIcon({ src, size }: { src: string; size: number }) {
  return (
    <img src={src} width={size} height={size}
      style={{ objectFit: 'cover', borderRadius: '22%', display: 'block', flexShrink: 0, border: ICON_BORDER }} />
  );
}

/** badge 内容：SVG path 或首字母文字 */
function BadgeContent({ path, letter, size, fg }: {
  path?: string; letter?: string; size: number; fg: string;
}) {
  if (path)
    return <svg width={size * 0.62} height={size * 0.62} viewBox="0 0 24 24" fill={fg}><path d={path} /></svg>;
  const st = { fontSize: size * 0.46, fontWeight: 700, color: fg, fontFamily: 'system-ui,sans-serif', lineHeight: 1 };
  return <span style={st}>{letter}</span>;
}

/** SVG path / 首字母 badge：品牌色背景 + 22% 圆角 */
function BadgeIcon({ path, letter, slug, size }: {
  path?: string; letter?: string; slug: string; size: number;
}) {
  const [bg, fg] = BRAND_COLORS[slug] ?? ['#374151', '#ffffff'];
  const st = { width: size, height: size, borderRadius: '22%', background: bg, border: ICON_BORDER,
               display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 };
  return <div style={st}><BadgeContent path={path} letter={letter} size={size} fg={fg} /></div>;
}

// ─── BrandIcon ────────────────────────────────────────────────────────────────
interface BrandIconProps {
  name: string;
  icon?: string;
  size?: number;
}

function FallbackBadge({ icon: Icon, size }: { icon: React.ElementType; size: number }) {
  const st = { width: size, height: size, borderRadius: '22%', background: '#f3f4f6',
               border: ICON_BORDER, display: 'flex', alignItems: 'center',
               justifyContent: 'center', flexShrink: 0 };
  return <div style={st}><Icon size={size * 0.55} color="#374151" /></div>;
}

export default function BrandIcon({ name, icon, size = 16 }: BrandIconProps) {
  const slug = icon || nameToSlug(name);
  if (slug) {
    const def = ICON_LIST.find(d => d.slug === slug);
    if (def?.img)  return <ImgIcon src={def.img} size={size} />;
    if (def?.path) return <BadgeIcon path={def.path} slug={slug} size={size} />;
    if (def)       return <BadgeIcon letter={def.label.charAt(0).toUpperCase()} slug={slug} size={size} />;
  }
  if (name.toLowerCase().includes('api') || name.includes('秘钥')) return <FallbackBadge icon={Key} size={size} />;
  return <FallbackBadge icon={BookOpen} size={size} />;
}
